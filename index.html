import React, { useEffect, useRef, useState } from 'react';

// --- HELPER: Load Script dari CDN ---
const loadScript = (src) => {
  return new Promise((resolve, reject) => {
    if (document.querySelector(`script[src="${src}"]`)) {
      resolve();
      return;
    }
    const script = document.createElement('script');
    script.src = src;
    script.async = true;
    script.onload = resolve;
    script.onerror = reject;
    document.head.appendChild(script);
  });
};

// --- HELPER: Export to CSV ---
const exportToCSV = (data, filename) => {
  if (!data || data.length === 0) {
    alert("Tidak ada data untuk diexport!");
    return;
  }
  const headers = Object.keys(data[0]);
  const csvRows = [];
  csvRows.push(headers.join(','));
  for (const row of data) {
    const values = headers.map(header => {
      const escaped = ('' + row[header]).replace(/"/g, '\\"');
      return `"${escaped}"`;
    });
    csvRows.push(values.join(','));
  }
  const csvString = csvRows.join('\n');
  const blob = new Blob([csvString], { type: 'text/csv' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.setAttribute('hidden', '');
  a.setAttribute('href', url);
  a.setAttribute('download', filename);
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
};

const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';

class FaceManagerService {
  constructor() {
    this.faceMatcher = null;
    this.isModelLoaded = false;
    this.useSimulation = false;
  }

  async loadModels() {
    if (this.isModelLoaded) return;
    try {
      console.log("Memuat library face-api.js...");
      await loadScript('https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js');
      await new Promise(r => setTimeout(r, 500));
      if (!window.faceapi) throw new Error("Gagal memuat face-api dari CDN");

      console.log("Memuat model AI...");
      await Promise.all([
        window.faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
        window.faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
        window.faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
      ]);
      this.isModelLoaded = true;
      console.log("Model AI siap.");
    } catch (error) {
      console.warn("‚ö†Ô∏è Gagal memuat model. Beralih ke MODE SIMULASI.", error);
      this.useSimulation = true;
      this.isModelLoaded = true;
    }
  }

  initMatcher(studentsData) {
    if (!this.isModelLoaded || !window.faceapi || this.useSimulation) return;
    try {
      const labeledDescriptors = studentsData
        .filter(s => s.faceDescriptor)
        .map(student => {
          try {
            const descriptorArray = JSON.parse(student.faceDescriptor);
            if (!Array.isArray(descriptorArray) || descriptorArray.length !== 128) return null;
            const float32Descriptor = new Float32Array(descriptorArray);
            return new window.faceapi.LabeledFaceDescriptors(String(student.id), [float32Descriptor]);
          } catch (err) {
            return null;
          }
        })
        .filter(d => d !== null);

      if (labeledDescriptors.length > 0) {
        this.faceMatcher = new window.faceapi.FaceMatcher(labeledDescriptors, 0.55);
      } else {
        this.faceMatcher = null;
      }
    } catch (e) {
      console.error("Error init matcher:", e);
    }
  }

  async getDescriptor(videoElement) {
    if (this.useSimulation) {
      return JSON.stringify(Array.from({length: 128}, () => Math.random()));
    }
    // Safety check tambahan
    if (!this.isModelLoaded || !window.faceapi) {
        console.error("FaceAPI belum siap saat getDescriptor dipanggil");
        return null;
    }
    try {
      const detection = await window.faceapi.detectSingleFace(
        videoElement, 
        new window.faceapi.TinyFaceDetectorOptions()
      ).withFaceLandmarks().withFaceDescriptor();
      if (!detection) return null;
      return JSON.stringify(Array.from(detection.descriptor));
    } catch (err) {
      console.error("Error deteksi wajah:", err);
      return null;
    }
  }

  async detectAndMatch(videoElement) {
    if (this.useSimulation) {
        const isDetecting = Math.random() > 0.7;
        if (!isDetecting) return [];
        return [{
            detection: { box: { x: 150 + Math.random() * 50, y: 100 + Math.random() * 30, width: 200, height: 200 } },
            match: { label: '1', distance: 0.4 }, 
            isUnknown: false
        }];
    }
    if (!this.isModelLoaded) return [];
    if (!this.faceMatcher) {
       try {
         const detections = await window.faceapi.detectAllFaces(videoElement, new window.faceapi.TinyFaceDetectorOptions())
           .withFaceLandmarks().withFaceDescriptors();
         return detections.map(d => ({
            detection: d,
            match: { label: 'unknown', distance: 1.0 },
            isUnknown: true
         }));
       } catch (e) { return []; }
    }
    try {
        const detections = await window.faceapi.detectAllFaces(videoElement, new window.faceapi.TinyFaceDetectorOptions())
        .withFaceLandmarks().withFaceDescriptors();
        return detections.map(d => {
            const match = this.faceMatcher.findBestMatch(d.descriptor);
            return {
                detection: d,
                match: match,
                isUnknown: match.label === 'unknown'
            };
        });
    } catch (err) { return []; }
  }
}

const faceManager = new FaceManagerService();

// --- COMPONENTS ---

const Navbar = ({ activeTab, setActiveTab }) => (
  <nav className="bg-indigo-600 text-white shadow-lg p-4 sticky top-0 z-50">
    <div className="container mx-auto flex justify-between items-center">
      <h1 className="text-xl font-bold flex items-center gap-2">
        üéì SmartAttendance
      </h1>
      <div className="flex gap-2 text-sm md:text-base overflow-x-auto">
        {['Absensi', 'Data Siswa', 'Laporan', 'Pengaturan'].map((tab) => (
          <button
            key={tab}
            onClick={() => setActiveTab(tab)}
            className={`px-3 py-2 rounded-lg transition-colors whitespace-nowrap ${
              activeTab === tab ? 'bg-white text-indigo-600 font-bold' : 'hover:bg-indigo-500'
            }`}
          >
            {tab}
          </button>
        ))}
      </div>
    </div>
  </nav>
);

const NativeWebcam = ({ videoRef, onReady }) => {
  const [error, setError] = useState(null);
  useEffect(() => {
    let stream = null;
    const startCamera = async () => {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ 
          video: { width: 640, height: 480, facingMode: 'user' } 
        });
        if (videoRef.current) {
          videoRef.current.srcObject = stream;
          videoRef.current.onloadedmetadata = () => {
            videoRef.current.play().catch(e => console.error(e));
            if (onReady) onReady();
          };
        }
      } catch (err) {
        setError("Izin kamera ditolak.");
      }
    };
    startCamera();
    return () => { if (stream) stream.getTracks().forEach(track => track.stop()); };
  }, [videoRef, onReady]);

  if (error) return <div className="bg-red-100 text-red-700 p-10 rounded text-center h-full flex items-center justify-center">{error}</div>;

  return <video ref={videoRef} className="w-full h-full object-cover transform scale-x-[-1] rounded-lg bg-gray-900" playsInline muted autoPlay />;
};

const CanvasOverlay = ({ dimensions, detections }) => {
  const canvasRef = useRef(null);
  useEffect(() => {
    if (canvasRef.current && detections.length > 0) {
      const ctx = canvasRef.current.getContext('2d');
      ctx.clearRect(0, 0, dimensions.width, dimensions.height);
      ctx.save();
      ctx.scale(-1, 1);
      ctx.translate(-dimensions.width, 0);
      detections.forEach(({ detection, match }) => {
        const { x, y, width, height } = detection.detection.box || detection.box;
        const color = match.label === 'unknown' ? '#ef4444' : '#22c55e';
        ctx.strokeStyle = color;
        ctx.lineWidth = 3;
        ctx.strokeRect(x, y, width, height);
        ctx.save();
        ctx.translate(x + width/2, y - 10);
        ctx.scale(-1, 1);
        ctx.fillStyle = color;
        ctx.font = 'bold 16px sans-serif';
        ctx.textAlign = 'center';
        let labelText = match.label === 'unknown' ? "Unknown" : "ID: " + match.label;
        ctx.fillText(labelText, 0, 0);
        ctx.restore();
      });
      ctx.restore();
    } else if (canvasRef.current) {
        const ctx = canvasRef.current.getContext('2d');
        ctx.clearRect(0, 0, dimensions.width, dimensions.height);
    }
  }, [detections, dimensions]);
  return <canvas ref={canvasRef} width={dimensions.width} height={dimensions.height} className="absolute top-0 left-0 w-full h-full pointer-events-none" />;
};

// --- VIEW: ABSENSI ---
const AttendanceView = ({ students, settings, onAttendanceSuccess, attendanceHistory }) => {
  const videoRef = useRef(null);
  const [loading, setLoading] = useState(true);
  const [logs, setLogs] = useState([]);
  const [detections, setDetections] = useState([]);
  const lastAttendanceRef = useRef({}); 
  const [feedback, setFeedback] = useState(null);
  const feedbackTimeoutRef = useRef(null);
  const validStudentsCount = students.filter(s => s.faceDescriptor).length;

  const showFeedback = (type, message, detail) => {
    setFeedback({ type, message, detail });
    if (feedbackTimeoutRef.current) clearTimeout(feedbackTimeoutRef.current);
    feedbackTimeoutRef.current = setTimeout(() => setFeedback(null), 2500);
  };

  // Helper: Cek Status Keterlambatan
  const checkStatus = () => {
      const now = new Date();
      const [startHour, startMinute] = settings.startTime.split(':').map(Number);
      
      const limitTime = new Date();
      limitTime.setHours(startHour, startMinute + parseInt(settings.lateTolerance), 0);

      // Jika waktu sekarang > (jam masuk + toleransi), maka terlambat
      return now > limitTime ? 'Terlambat' : 'Hadir';
  };

  useEffect(() => {
    const init = async () => {
      await faceManager.loadModels();
      faceManager.initMatcher(students);
      setLoading(false);
      setLogs(prev => ["Sistem siap. Menunggu wajah...", ...prev]);
    };
    init();
  }, [students]);

  useEffect(() => {
    if (loading) return;
    const interval = setInterval(async () => {
      if (videoRef.current && !videoRef.current.paused && !videoRef.current.ended) {
        const results = await faceManager.detectAndMatch(videoRef.current);
        setDetections(results);
        if (results.length > 0) {
            const bestResult = results[0];
            const { label, distance } = bestResult.match;
            if (label !== 'unknown') {
                const now = Date.now();
                
                // --- UPDATE: Cek apakah sudah absen hari ini ---
                const todayStr = new Date().toLocaleDateString('id-ID');
                const alreadyAttended = attendanceHistory.some(
                    r => String(r.studentId) === String(label) && r.date === todayStr
                );

                if (alreadyAttended) {
                     // Tampilkan info "Sudah Absen" tapi dengan cooldown agar tidak spam
                     if (!lastAttendanceRef.current[label] || (now - lastAttendanceRef.current[label] > 5000)) {
                         const student = students.find(s => String(s.id) === label);
                         const studentName = student ? student.name : `ID:${label}`;
                         showFeedback('info', 'Sudah Absen', `${studentName} sudah tercatat hadir hari ini.`);
                         lastAttendanceRef.current[label] = now;
                     }
                     // Skip proses selanjutnya (jangan catat lagi)
                } else {
                    // --- Logic Absensi Baru (Jika Belum Absen) ---
                    if (!lastAttendanceRef.current[label] || (now - lastAttendanceRef.current[label] > 10000)) {
                      const student = students.find(s => String(s.id) === label);
                      const studentName = student ? student.name : `ID:${label}`;
                      const accuracy = ((1-distance)*100).toFixed(0);
                      const status = checkStatus();
                      
                      const statusIcon = status === 'Hadir' ? '‚úÖ' : '‚ö†Ô∏è';
                      const logMsg = `${statusIcon} ${studentName} - ${status} (${accuracy}%)`;
                      
                      setLogs(p => [logMsg, ...p].slice(0, 10));
                      lastAttendanceRef.current[label] = now;
                      
                      onAttendanceSuccess({
                        id: Date.now(),
                        studentId: label,
                        nis: student ? student.nis : '-',
                        name: studentName,
                        kelas: student ? student.kelas : '-',
                        time: new Date().toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'}),
                        date: todayStr,
                        status: status,
                        accuracy: accuracy + '%'
                      });

                      if (status === 'Hadir') {
                          showFeedback('success', 'Terima Kasih', `Selamat Datang, ${studentName}. Tepat Waktu!`);
                      } else {
                          showFeedback('warning', 'Terlambat!', `${studentName}, kamu terlambat masuk.`);
                      }
                    }
                }
            } else {
                if (!feedback || (feedback.type !== 'success' && feedback.type !== 'warning' && feedback.type !== 'info')) {
                    showFeedback('error', 'Proses Gagal', 'Wajah tidak dikenali');
                }
            }
        }
      }
    }, 1000);
    return () => clearInterval(interval);
  }, [loading, students, feedback, settings, attendanceHistory]);

  return (
    <div className="flex flex-col md:flex-row gap-6 h-full">
      <div className="flex-1 bg-black rounded-2xl overflow-hidden shadow-2xl relative min-h-[400px]">
        {loading && <div className="absolute inset-0 z-20 flex items-center justify-center bg-gray-900 text-white">Memuat AI...</div>}
        <NativeWebcam videoRef={videoRef} />
        <CanvasOverlay dimensions={{ width: 640, height: 480 }} detections={detections} />
        {feedback && (
            <div className={`absolute inset-0 z-30 flex flex-col items-center justify-center bg-black/70 backdrop-blur-sm animate-in fade-in`}>
                <div className={`p-6 rounded-2xl shadow-2xl text-center transform scale-110 ${
                    feedback.type === 'success' ? 'bg-green-600' : 
                    feedback.type === 'warning' ? 'bg-yellow-600' : 
                    feedback.type === 'info' ? 'bg-blue-600' : 'bg-red-600'
                } text-white`}>
                    <div className="text-6xl mb-4">
                        {feedback.type === 'success' ? 'ü§©' : 
                         feedback.type === 'warning' ? 'üèÉ' : 
                         feedback.type === 'info' ? '‚ÑπÔ∏è' : 'ü§î'}
                    </div>
                    <h2 className="text-3xl font-extrabold mb-2">{feedback.message}</h2>
                    <p className="text-lg opacity-90">{feedback.detail}</p>
                </div>
            </div>
        )}
        <div className="absolute top-4 left-4 flex flex-col gap-2 pointer-events-none">
            <div className="bg-black/60 text-white px-3 py-1 rounded-full text-sm backdrop-blur-sm flex items-center gap-2 w-fit">
              <span className="w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>Live Camera
            </div>
            {validStudentsCount === 0 && (
                <div className="bg-yellow-500/80 text-white px-3 py-1 rounded-full text-xs backdrop-blur-sm w-fit">‚ö†Ô∏è Belum ada wajah terdaftar.</div>
            )}
        </div>
        <div className="absolute top-4 right-4 bg-white/90 text-gray-800 px-3 py-1 rounded-lg text-xs font-bold shadow">
             Jam Masuk: {settings.startTime} (Tol: {settings.lateTolerance}m)
        </div>
      </div>
      <div className="w-full md:w-96 bg-white rounded-2xl shadow-xl flex flex-col overflow-hidden h-[500px]">
        <div className="p-4 bg-gray-50 border-b border-gray-200">
          <h2 className="font-bold text-gray-700">Log Aktivitas</h2>
          <p className="text-xs text-gray-500 mt-1">Total Wajah Terdaftar: {validStudentsCount}</p>
        </div>
        <div className="flex-1 overflow-y-auto p-4 space-y-3">
          {logs.map((log, i) => (
            <div key={i} className={`flex items-center gap-3 p-3 rounded-lg border text-sm animate-pulse-once ${
                log.includes('Terlambat') ? 'bg-yellow-50 text-yellow-800 border-yellow-200' : 
                log.includes('‚úÖ') ? 'bg-green-50 text-green-800 border-green-200' : 
                'bg-gray-50 text-gray-800'
            }`}>{log}</div>
          ))}
        </div>
      </div>
    </div>
  );
};

// --- VIEW: MANAJEMEN SISWA ---
const StudentManagementView = ({ students, onImport, onRegisterStudent, onRegisterFace, onDelete }) => {
  const [scanMode, setScanMode] = useState(false);
  const [selectedStudent, setSelectedStudent] = useState(null);
  const videoRef = useRef(null);
  const [isScanning, setIsScanning] = useState(false);
  const fileInputRef = useRef(null);
  
  const [newStudent, setNewStudent] = useState({ nis: '', name: '', kelas: '' });
  const [showAddForm, setShowAddForm] = useState(false);
  const [isUploading, setIsUploading] = useState(false);
  const [uploadProgress, setUploadProgress] = useState(0);

  // Perbaikan 1: Pastikan Model AI dimuat saat tab ini dibuka
  useEffect(() => {
    faceManager.loadModels().catch(console.error);
  }, []);

  const handleFileChange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    setIsUploading(true);
    setUploadProgress(10);

    if (!window.XLSX) {
        try {
            await loadScript('https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js');
            setUploadProgress(30);
        } catch (err) {
            alert("Gagal memuat library Excel. Periksa koneksi internet.");
            setIsUploading(false);
            setUploadProgress(0);
            return;
        }
    }

    const reader = new FileReader();
    reader.onprogress = (data) => {
        if (data.lengthComputable) {
            const percent = parseInt(((data.loaded / data.total) * 40) + 30, 10);
            setUploadProgress(percent);
        }
    };

    reader.onload = async (evt) => {
      setUploadProgress(75);
      await new Promise(r => setTimeout(r, 200));

      try {
        const data = evt.target.result;
        const workbook = window.XLSX.read(data, { type: 'binary' });
        setUploadProgress(85);

        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];
        const jsonData = window.XLSX.utils.sheet_to_json(sheet);
        setUploadProgress(95);

        if (jsonData.length === 0) {
            alert("File Excel kosong atau format salah.");
            setIsUploading(false);
            return;
        }

        const normalizeKeys = (obj) => {
            const newObj = {};
            Object.keys(obj).forEach(key => {
                const normalizedKey = key.trim().toLowerCase();
                newObj[normalizedKey] = obj[key];
            });
            return newObj;
        };

        const parsedStudents = jsonData.map((rawRow, index) => {
             const row = normalizeKeys(rawRow);
             const nis = row['nis'] || row['no induk'] || row['nomor induk'] || row['id'] || '';
             const name = row['nama'] || row['nama siswa'] || row['nama lengkap'] || row['name'] || '';
             const kelas = row['kelas'] || row['class'] || row['rombel'] || '-';

             return {
                 id: Date.now() + index,
                 nis: String(nis),
                 name: name,
                 kelas: kelas,
                 faceDescriptor: null
             };
        }).filter(s => s.nis && s.name);

        setUploadProgress(100);
        await new Promise(r => setTimeout(r, 300));

        if (parsedStudents.length === 0) {
            alert("Data tidak ditemukan! Pastikan header kolom Excel adalah: NIS, Nama, Kelas.");
        } else {
            onImport(parsedStudents);
            alert(`Berhasil mengimpor ${parsedStudents.length} data siswa dari Excel!`);
        }
        
        fileInputRef.current.value = "";
      } catch (error) {
        console.error(error);
        alert("Gagal membaca file Excel. Pastikan format benar.");
      } finally {
          setIsUploading(false);
          setUploadProgress(0);
      }
    };
    reader.readAsBinaryString(file);
  };

  const handleStartScan = (student) => {
    setSelectedStudent(student);
    setScanMode(true);
    // Double check model load when entering scan mode
    faceManager.loadModels();
  };

  const handleCaptureFace = async () => {
    if (!videoRef.current) return;
    setIsScanning(true);
    
    // Perbaikan 2: Pengecekan Eksplisit Model AI
    if (!faceManager.isModelLoaded) {
        try {
            await faceManager.loadModels();
        } catch (e) {
            alert("Gagal memuat sistem AI. Periksa koneksi internet lalu coba lagi.");
            setIsScanning(false);
            return;
        }
    }

    await new Promise(r => setTimeout(r, 500));
    const descriptor = await faceManager.getDescriptor(videoRef.current);
    
    if (descriptor) {
      onRegisterFace(selectedStudent.id, descriptor);
      setScanMode(false);
      setSelectedStudent(null);
      alert(`Wajah untuk ${selectedStudent.name} berhasil direkam!`);
    } else {
      alert("Wajah tidak terdeteksi. Pastikan pencahayaan cukup dan wajah menghadap kamera.");
    }
    setIsScanning(false);
  };

  const handleManualSubmit = (e) => {
    e.preventDefault();
    if (newStudent.nis && newStudent.name) {
        onRegisterStudent({
            nis: newStudent.nis,
            name: newStudent.name,
            kelas: newStudent.kelas || '-',
            faceDescriptor: null
        });
        setNewStudent({ nis: '', name: '', kelas: '' });
        alert("Siswa berhasil ditambahkan!");
    }
  };

  if (scanMode && selectedStudent) {
    return (
      <div className="bg-white p-6 rounded-2xl shadow-xl max-w-2xl mx-auto text-center">
        <h2 className="text-2xl font-bold mb-4">Scan Wajah: {selectedStudent.name}</h2>
        <div className="relative bg-black rounded-xl overflow-hidden min-h-[400px] mb-4">
          <NativeWebcam videoRef={videoRef} />
          <div className="absolute inset-0 border-4 border-white/20 rounded-xl pointer-events-none"></div>
          <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-64 h-64 border-2 border-dashed border-white/50 rounded-full pointer-events-none"></div>
        </div>
        <div className="flex gap-4 justify-center">
          <button onClick={() => setScanMode(false)} className="px-6 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Batal</button>
          <button onClick={handleCaptureFace} disabled={isScanning} className="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 flex items-center gap-2">
            {isScanning && <div className="animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full"></div>}
            {isScanning ? "Memproses..." : "üì∏ Ambil Foto"}
          </button>
        </div>
      </div>
    );
  }

  return (
    <div className="bg-white p-8 rounded-2xl shadow-xl space-y-6">
      <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
        <div>
           <h2 className="text-2xl font-bold text-gray-800">Manajemen Data Siswa</h2>
           <p className="text-gray-500 text-sm">Kelola data siswa, import Excel, atau tambah manual.</p>
        </div>
        <div className="flex flex-col md:flex-row gap-3 items-center">
          <input 
            type="file" 
            accept=".xlsx, .xls" 
            ref={fileInputRef} 
            onChange={handleFileChange} 
            className="hidden" 
          />
          <button 
            onClick={() => fileInputRef.current.click()} 
            disabled={isUploading}
            className={`flex items-center gap-2 px-4 py-2 text-white rounded-lg transition shadow-md ${isUploading ? 'bg-gray-400 cursor-wait' : 'bg-green-600 hover:bg-green-700'}`}
          >
            {isUploading ? `Loading ${uploadProgress}%` : 'üìä Import Excel'}
          </button>
          <button 
            onClick={() => setShowAddForm(!showAddForm)}
            className="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition shadow-md"
          >
            {showAddForm ? '‚ùå Batal' : '‚ûï Tambah Manual'}
          </button>
        </div>
      </div>

      {isUploading && (
          <div className="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700 overflow-hidden animate-in fade-in">
            <div 
                className="bg-green-600 h-2.5 rounded-full transition-all duration-300 ease-out" 
                style={{ width: `${uploadProgress}%` }}
            ></div>
            <p className="text-xs text-center mt-1 text-gray-500">Memproses Data... {uploadProgress}%</p>
          </div>
      )}

      {showAddForm && (
        <div className="bg-indigo-50 p-6 rounded-xl border border-indigo-100 animate-in fade-in">
            <h3 className="font-bold text-indigo-900 mb-4">Tambah Siswa Baru</h3>
            <form onSubmit={handleManualSubmit} className="flex flex-col md:flex-row gap-4 items-end">
                <div className="flex-1 w-full">
                    <label className="block text-xs font-bold text-gray-500 mb-1">NIS</label>
                    <input 
                        type="text" 
                        value={newStudent.nis}
                        onChange={e => setNewStudent({...newStudent, nis: e.target.value})}
                        className="w-full px-3 py-2 rounded-lg border focus:ring-2 focus:ring-indigo-500 outline-none"
                        placeholder="12345"
                        required
                    />
                </div>
                <div className="flex-1 w-full">
                    <label className="block text-xs font-bold text-gray-500 mb-1">Nama Lengkap</label>
                    <input 
                        type="text" 
                        value={newStudent.name}
                        onChange={e => setNewStudent({...newStudent, name: e.target.value})}
                        className="w-full px-3 py-2 rounded-lg border focus:ring-2 focus:ring-indigo-500 outline-none"
                        placeholder="Nama Siswa"
                        required
                    />
                </div>
                <div className="flex-1 w-full">
                    <label className="block text-xs font-bold text-gray-500 mb-1">Kelas</label>
                    <input 
                        type="text" 
                        value={newStudent.kelas}
                        onChange={e => setNewStudent({...newStudent, kelas: e.target.value})}
                        className="w-full px-3 py-2 rounded-lg border focus:ring-2 focus:ring-indigo-500 outline-none"
                        placeholder="X-RPL"
                    />
                </div>
                <button type="submit" className="px-6 py-2 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 w-full md:w-auto">
                    Simpan
                </button>
            </form>
        </div>
      )}

      <div className="overflow-x-auto border rounded-xl">
        <table className="w-full text-left border-collapse">
          <thead className="bg-gray-50 text-gray-600 uppercase text-xs">
            <tr>
              <th className="px-6 py-3 border-b">NIS</th>
              <th className="px-6 py-3 border-b">Nama</th>
              <th className="px-6 py-3 border-b">Kelas</th>
              <th className="px-6 py-3 border-b">Status Wajah</th>
              <th className="px-6 py-3 border-b">Aksi</th>
            </tr>
          </thead>
          <tbody className="divide-y divide-gray-200">
            {students.length > 0 ? students.map((s) => (
              <tr key={s.id} className="hover:bg-gray-50">
                <td className="px-6 py-4">{s.nis}</td>
                <td className="px-6 py-4 font-bold">{s.name}</td>
                <td className="px-6 py-4">{s.kelas}</td>
                <td className="px-6 py-4">
                  {s.faceDescriptor ? (
                    <span className="px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs font-bold">Terdaftar ‚úÖ</span>
                  ) : (
                    <span className="px-2 py-1 bg-gray-100 text-gray-500 rounded-full text-xs">Belum Ada ‚ùå</span>
                  )}
                </td>
                <td className="px-6 py-4 flex gap-2">
                  <button 
                    onClick={() => handleStartScan(s)}
                    className="px-3 py-1 bg-indigo-100 text-indigo-700 rounded hover:bg-indigo-200 text-sm font-bold"
                  >
                    {s.faceDescriptor ? "Update Wajah" : "üì∑ Scan Wajah"}
                  </button>
                  <button 
                    onClick={() => onDelete(s.id)}
                    className="px-3 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200 text-sm"
                  >
                    Hapus
                  </button>
                </td>
              </tr>
            )) : (
              <tr>
                <td colSpan="5" className="text-center py-10 text-gray-400">
                  <div className="flex flex-col items-center">
                    <span className="text-4xl mb-2">üìÇ</span>
                    <p>Belum ada data siswa.</p>
                    <p className="text-sm">Gunakan Import Excel atau Tambah Manual</p>
                  </div>
                </td>
              </tr>
            )}
          </tbody>
        </table>
      </div>
    </div>
  );
};

// --- VIEW: LAPORAN (GROUPED BY CLASS) ---
const ReportView = ({ attendanceHistory }) => {
  // Grouping Data
  const groupedData = attendanceHistory.reduce((acc, curr) => {
    const className = curr.kelas || 'Lainnya';
    if (!acc[className]) acc[className] = [];
    acc[className].push(curr);
    return acc;
  }, {});

  const classNames = Object.keys(groupedData).sort();

  return (
    <div className="bg-white p-8 rounded-2xl shadow-xl space-y-8">
        <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
            <div>
                <h2 className="text-2xl font-bold text-gray-800 flex items-center gap-2">
                    üìÖ Laporan Kehadiran
                </h2>
                <p className="text-sm text-gray-500">Laporan dikelompokkan berdasarkan kelas.</p>
            </div>
            <button 
                onClick={() => exportToCSV(attendanceHistory, `Laporan_Absensi_${new Date().toISOString().split('T')[0]}.csv`)}
                className="flex items-center gap-2 px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition shadow-lg"
            >
                üì• Export ke Excel (.csv)
            </button>
        </div>

        {classNames.length > 0 ? (
            classNames.map(className => (
                <div key={className} className="border rounded-xl shadow-sm overflow-hidden">
                    <div className="bg-indigo-50 px-6 py-3 border-b flex justify-between items-center">
                        <h3 className="font-bold text-indigo-800 text-lg">Kelas: {className}</h3>
                        <span className="bg-indigo-200 text-indigo-800 text-xs px-2 py-1 rounded-full">
                            {groupedData[className].length} Siswa
                        </span>
                    </div>
                    <div className="overflow-x-auto">
                        <table className="w-full text-left border-collapse">
                            <thead className="bg-gray-50 text-gray-600 uppercase text-xs font-bold">
                            <tr>
                                <th className="px-6 py-3 border-b">Waktu</th>
                                <th className="px-6 py-3 border-b">NIS</th>
                                <th className="px-6 py-3 border-b">Nama Siswa</th>
                                <th className="px-6 py-3 border-b">Tanggal</th>
                                <th className="px-6 py-3 border-b">Status</th>
                                <th className="px-6 py-3 border-b">Akurasi</th>
                            </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-200">
                                {groupedData[className].map((record) => (
                                    <tr key={record.id} className="hover:bg-indigo-50/50 transition-colors">
                                        <td className="px-6 py-4 font-mono text-sm">{record.time}</td>
                                        <td className="px-6 py-4 text-sm">{record.nis}</td>
                                        <td className="px-6 py-4 font-bold text-gray-700">{record.name}</td>
                                        <td className="px-6 py-4">{record.date}</td>
                                        <td className="px-6 py-4">
                                            <span className={`px-3 py-1 rounded-full text-xs font-bold ${
                                                record.status === 'Hadir' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'
                                            }`}>
                                                {record.status}
                                            </span>
                                        </td>
                                        <td className="px-6 py-4 text-xs text-gray-500">{record.accuracy}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            ))
        ) : (
            <div className="text-center py-12 text-gray-400 italic bg-gray-50 rounded-xl border border-dashed">
                Belum ada data kehadiran hari ini.
            </div>
        )}
    </div>
  );
};

// --- VIEW: PENGATURAN ---
const SettingsView = ({ settings, setSettings }) => {
    const [localSettings, setLocalSettings] = useState(settings);

    const handleSave = () => {
        setSettings(localSettings);
        alert("Pengaturan berhasil disimpan!");
    };

    return (
        <div className="bg-white p-8 rounded-2xl shadow-xl max-w-2xl mx-auto">
            <h2 className="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                ‚öôÔ∏è Pengaturan Sekolah
            </h2>
            
            <div className="space-y-6">
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Jam Masuk Sekolah</label>
                    <input 
                        type="time" 
                        value={localSettings.startTime}
                        onChange={(e) => setLocalSettings({...localSettings, startTime: e.target.value})}
                        className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none"
                    />
                    <p className="text-xs text-gray-500 mt-1">Waktu dimulainya jam pelajaran.</p>
                </div>

                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Batas Toleransi Keterlambatan (Menit)</label>
                    <input 
                        type="number" 
                        value={localSettings.lateTolerance}
                        onChange={(e) => setLocalSettings({...localSettings, lateTolerance: e.target.value})}
                        className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none"
                    />
                    <p className="text-xs text-gray-500 mt-1">Siswa dianggap terlambat jika hadir melebihi Jam Masuk + Toleransi.</p>
                </div>

                <div className="pt-4 border-t">
                    <button 
                        onClick={handleSave}
                        className="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 transition shadow-lg"
                    >
                        Simpan Pengaturan
                    </button>
                </div>
            </div>
        </div>
    );
};

// --- MAIN APP ---
export default function App() {
  const [activeTab, setActiveTab] = useState('Absensi');
  const [students, setStudents] = useState([]);
  const [attendanceHistory, setAttendanceHistory] = useState([]);
  
  // State Pengaturan Global
  const [settings, setSettings] = useState({
      startTime: '07:00',
      lateTolerance: 15 // menit
  });

  // Ensure Tailwind is loaded
  useEffect(() => {
    const loadTailwind = async () => {
        try {
            await loadScript('https://cdn.tailwindcss.com');
        } catch (e) {
            console.error("Tailwind load failed", e);
        }
    };
    if (!window.tailwind) loadTailwind();
  }, []);

  const handleImportStudents = (newStudents) => setStudents(prev => [...prev, ...newStudents]);
  const handleRegisterStudent = (newStudentData) => setStudents(prev => [...prev, { id: Date.now(), ...newStudentData }]);
  const handleRegisterFace = (id, descriptor) => setStudents(prev => prev.map(s => s.id === id ? { ...s, faceDescriptor: descriptor } : s));
  const handleDeleteStudent = (id) => { if (window.confirm("Yakin hapus?")) setStudents(prev => prev.filter(s => s.id !== id)); };
  const handleAttendanceSuccess = (record) => setAttendanceHistory(prev => [record, ...prev]);

  return (
    <div className="min-h-screen bg-gray-100 font-sans text-gray-900">
      <Navbar activeTab={activeTab} setActiveTab={setActiveTab} />
      
      <main className="container mx-auto p-4 md:p-6 pb-20">
        <div className="fade-in">
          {activeTab === 'Absensi' && (
            <AttendanceView 
                students={students} 
                settings={settings}
                onAttendanceSuccess={handleAttendanceSuccess}
                attendanceHistory={attendanceHistory} // --- Added Prop here ---
            />
          )}
          {activeTab === 'Data Siswa' && (
            <StudentManagementView 
                students={students} 
                onImport={handleImportStudents}
                onRegisterStudent={handleRegisterStudent}
                onRegisterFace={handleRegisterFace}
                onDelete={handleDeleteStudent}
            />
          )}
          {activeTab === 'Laporan' && (
            <ReportView attendanceHistory={attendanceHistory} />
          )}
          {activeTab === 'Pengaturan' && (
            <SettingsView settings={settings} setSettings={setSettings} />
          )}
        </div>
      </main>

      <style>{`
        .animate-pulse-once { animation: pulse-green 1s ease-out; }
        @keyframes pulse-green {
          0% { background-color: #dcfce7; }
          100% { background-color: #f0fdf4; }
        }
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-in { animation: fade-in 0.3s ease-out forwards; }
      `}</style>
    </div>
  );
}
